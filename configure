#!/bin/zsh
# vim: ft=zsh sw=4 ts=4 noet!
target=Makefile
arguments="$@"
typeset -A opts;
opts=(prefix /usr/local)

if [[ $1 == "--help" || $1 == "-h" ]]; then
cat >&1 <<EOH
Usage:
    ./configure --prefix[=[PATH]]

Available options:

    - prefix      - Set install prefix

All options are enabled by default.

Example:

    # Disable lock, parallel, cache and defer
    ./configure --disable-extensions

    # Disable completion
    ./configure --disable-completion
    
    # Enable debug
    ./configure --with-debug

EOH
  exit 0 
fi


while [[ $# -gt 0 ]]; do
    argkey="${1%\=*}"
    key="${argkey//--/}"
    if [[ $1 = *=* ]]; then
      value="${1#*=}"
    else
      value=$opts[$key]
    fi

  if [[ $opts[$key] != "" ]]; then
    opts[$key]=$value
  else
    printf "Invalid argument: %s (%s)\n" $key $1 >&2
    exit 1
  fi

  shift

done

BANNER_SEP=$(printf '%*s' 70 | tr ' ' '\#')

cat > $target <<EOM
${BANNER_SEP}
# This file was autogenerated by 'configure'. Do not edit it directly!
# Invocation was: $0 $arguments
${BANNER_SEP}
EOM

{
  for config in ${(k)opts}; do
    echo "${${config:u}//-/_}=${opts[$config]}"
  done

  echo ${BANNER_SEP}
  cat Makefile.in
} >> $target
